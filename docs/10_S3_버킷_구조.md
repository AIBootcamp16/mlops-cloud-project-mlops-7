# S3 버킷 구조 및 데이터 저장 방식

## 📋 개요

MLOps 프로젝트에서 사용하는 S3 버킷의 전체 구조와 각 디렉토리별 데이터 저장 방식을 설명합니다.

## 🗂️ 전체 S3 버킷 구조

```
s3://{bucket-name}/
├── weather_pm10_integrated_full.csv              # 마스터 학습 데이터 (21개월치)
├── raw/                                          # 원시 데이터 저장소
│   ├── asos/                                     # 기상청 ASOS 원시 데이터
│   │   └── year=YYYY/month=MM/day=DD/
│   │       └── HHMMSS.txt                        # 시간별 원시 응답
│   └── pm10/                                     # 미세먼지 원시 데이터
│       └── year=YYYY/month=MM/day=DD/
│           └── HHMMSS.txt                        # 시간별 원시 응답
├── processed/                                    # 파싱된 데이터 저장소
│   ├── asos/                                     # ASOS 파싱 결과
│   │   └── year=YYYY/month=MM/day=DD/
│   │       └── HHMMSS.json                       # JSON 형태 파싱 데이터
│   └── pm10/                                     # PM10 파싱 결과
│       └── year=YYYY/month=MM/day=DD/
│           └── HHMMSS.json                       # JSON 형태 파싱 데이터
└── ml_dataset/                                   # ML 데이터셋 저장소
    └── year=YYYY/month=MM/day=DD/
        ├── dataset_HHMMSS.parquet                # 실시간 추론용 (라벨 없음)
        └── dataset_HHMMSS_training_master.parquet # 학습용 마스터 (라벨 포함)
```

## 📂 디렉토리별 상세 설명

### 1. 루트 레벨 마스터 파일

#### `weather_pm10_integrated_full.csv`
- **용도**: 모델 학습을 위한 통합 마스터 데이터
- **보존 기간**: 21개월 (630일)
- **업데이트**: Rolling Window 방식으로 1시간마다 자동 업데이트
- **데이터 형식**: CSV (온도 + PM10 통합)

```csv
datetime,STN,temperature,pm10,humidity,pressure,...
2024-01-01 00:00:00,108,12.5,45.2,65.3,1013.2,...
2024-01-01 01:00:00,108,12.8,43.1,66.1,1013.5,...
...
```

### 2. Raw 데이터 디렉토리

#### `raw/asos/year=YYYY/month=MM/day=DD/`
- **용도**: 기상청 ASOS API 원시 응답 저장
- **파일 형식**: `.txt` (원본 XML/JSON 응답)
- **파일명**: `HHMMSS.txt` (수집 시각 기준)
- **내용**: KMA API 원본 응답 그대로 저장

```
raw/asos/year=2025/month=09/day=26/143000.txt
└── 기상청 ASOS API 원본 응답 (XML 형태)
```

#### `raw/pm10/year=YYYY/month=MM/day=DD/`
- **용도**: 미세먼지 API 원시 응답 저장
- **파일 형식**: `.txt` (원본 XML/JSON 응답)
- **파일명**: `HHMMSS.txt` (수집 시각 기준)
- **내용**: 미세먼지 API 원본 응답 그대로 저장

### 3. Processed 데이터 디렉토리

#### `processed/asos/year=YYYY/month=MM/day=DD/`
- **용도**: ASOS 원시 데이터 파싱 결과
- **파일 형식**: `.json`
- **파일명**: `HHMMSS.json`
- **내용**: 구조화된 JSON 데이터

```json
[
  {
    "station_id": "108",
    "observed_at": "2025-09-26T14:00:00+09:00",
    "category": "asos",
    "value": 22.5,
    "unit": "°C"
  }
]
```

#### `processed/pm10/year=YYYY/month=MM/day=DD/`
- **용도**: PM10 원시 데이터 파싱 결과
- **파일 형식**: `.json`
- **내용**: 구조화된 미세먼지 데이터

```json
[
  {
    "station_id": "108",
    "observed_at": "2025-09-26T14:00:00+09:00",
    "category": "pm10",
    "value": 35.2,
    "unit": "μg/m³"
  }
]
```

### 4. ML Dataset 디렉토리

#### `ml_dataset/year=YYYY/month=MM/day=DD/`

**실시간 추론용**: `dataset_HHMMSS.parquet`
- **용도**: 실시간 모델 추론
- **특징**: `comfort_score` (정답) 없음
- **피처 수**: 34개 (UV 제거 후)
- **형식**: Parquet

**학습용 마스터**: `dataset_HHMMSS_training_master.parquet`
- **용도**: 모델 학습 및 검증
- **특징**: `comfort_score` (정답) 포함
- **피처 수**: 34개 + 1개 라벨
- **형식**: Parquet

## 🔧 파티션 구조의 장점

### Hive-Style 파티셔닝
```
year=2025/month=09/day=26/
```

**장점:**
- **쿼리 성능**: 날짜 기반 필터링 시 빠른 조회
- **병렬 처리**: 파티션별 독립적 처리 가능
- **비용 효율**: 필요한 파티션만 스캔하여 비용 절약
- **확장성**: 데이터 증가에 따른 선형 확장

### 파티션별 데이터 분포
```
year=2025/
├── month=01/ (1월 데이터)
├── month=02/ (2월 데이터)
├── ...
└── month=09/
    ├── day=01/ (9월 1일)
    ├── day=02/ (9월 2일)
    ├── ...
    └── day=26/ (9월 26일)
        ├── 143000.txt (14:30:00 수집)
        ├── 153000.txt (15:30:00 수집)
        └── ...
```

## 📊 데이터 플로우

### 실시간 데이터 처리 흐름
```
KMA API 호출
    ↓
raw/ 디렉토리에 원시 데이터 저장
    ↓
데이터 파싱
    ↓
processed/ 디렉토리에 JSON 저장
    ↓
피처 엔지니어링
    ↓
ml_dataset/ 디렉토리에 Parquet 저장
    ↓
마스터 데이터 Rolling Window 업데이트
```

### 데이터 보존 정책

| 디렉토리 | 보존 기간 | 삭제 정책 |
|----------|-----------|-----------|
| `raw/` | 무제한 | 수동 삭제 |
| `processed/` | 무제한 | 수동 삭제 |
| `ml_dataset/` | 무제한 | 수동 삭제 |
| `weather_pm10_integrated_full.csv` | 21개월 | 자동 Rolling Window |

## 🚀 파일 명명 규칙

### 시간 기반 파일명
- **원시/파싱 데이터**: `HHMMSS.{확장자}` (수집 시각)
- **ML 데이터셋**: `dataset_HHMMSS.parquet` (생성 시각)
- **학습용 마스터**: `dataset_HHMMSS_training_master.parquet`

### 예시
```
143000.txt          # 14:30:00에 수집된 원시 데이터
143000.json         # 14:30:00 데이터의 파싱 결과
dataset_143000.parquet              # 14:30:00에 생성된 추론용 데이터셋
dataset_143000_training_master.parquet # 14:30:00에 생성된 학습용 데이터셋
```

## 🔍 S3 객체 메타데이터

### Content-Type 설정
| 파일 형식 | Content-Type |
|-----------|--------------|
| `.txt` | `text/plain` |
| `.json` | `application/json` |
| `.csv` | `text/csv` |
| `.parquet` | `application/octet-stream` |

### 압축 및 인코딩
- **텍스트 파일**: UTF-8 인코딩
- **JSON 파일**: UTF-8 인코딩, `ensure_ascii=False`
- **CSV 파일**: UTF-8 인코딩
- **Parquet 파일**: 내장 압축 (Snappy)

## ⚙️ 자동화된 관리 작업

### 1. Rolling Window (1시간마다)
```python
# 마스터 데이터 자동 업데이트
weather_processor.update_master_training_dataset(new_data_df)
```

### 2. 실시간 데이터 적재 (1시간마다)
```python
# 원시 → 파싱 → ML 데이터셋 생성
weather_processor.process_and_store_weather_data(asos_raw, pm10_raw)
```

## 📈 용량 관리

### 예상 데이터 크기 (1일 기준)
- **원시 데이터**: ~100KB/일 (ASOS + PM10)
- **파싱 데이터**: ~50KB/일 (JSON 압축)
- **ML 데이터셋**: ~10KB/일 (Parquet 압축)
- **마스터 CSV**: ~10MB (21개월치 누적)

### 총 예상 용량 (21개월)
- **Raw**: ~65MB
- **Processed**: ~32MB
- **ML Dataset**: ~6MB
- **Master CSV**: ~10MB
- **총 용량**: ~113MB

## 🔒 접근 권한 및 보안

### IAM 권한 설정
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::your-bucket-name",
        "arn:aws:s3:::your-bucket-name/*"
      ]
    }
  ]
}
```

## 🛠️ 관리 및 모니터링

### S3 버킷 상태 확인
```bash
# 전체 구조 확인
aws s3 ls s3://your-bucket-name/ --recursive

# 특정 날짜 데이터 확인
aws s3 ls s3://your-bucket-name/ml_dataset/year=2025/month=09/day=26/

# 마스터 파일 확인
aws s3 ls s3://your-bucket-name/weather_pm10_integrated_full.csv
```

### 데이터 무결성 검증
```python
# 최신 ML 데이터셋 로드 테스트
df = weather_handler.load_latest_ml_dataset()

# 마스터 CSV 로드 테스트
master_df = weather_handler.load_csv_from_s3("weather_pm10_integrated_full.csv")
```

## ⚠️ 주의사항

### 파티션 구조 규칙
- **일관성 유지**: 모든 데이터는 동일한 파티션 구조 사용
- **시간대 주의**: UTC vs KST 시간 혼동 방지
- **파일명 중복**: 같은 시간에 여러 번 실행 시 덮어쓰기 발생

### 데이터 정합성
- **원자성**: 파일 업로드 실패 시 부분 데이터 방지
- **일관성**: 원시 → 파싱 → ML 데이터셋 간 일관성 유지
- **중복 제거**: 동일 시간 데이터 중복 방지

---

**작성일**: 2025-09-26
**버전**: v1.0 (파티션 구조 적용)
**관리**: S3 버킷 구조 변경 시 이 문서도 함께 업데이트