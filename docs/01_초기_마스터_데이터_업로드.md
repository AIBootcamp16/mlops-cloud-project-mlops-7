# 초기 마스터 데이터 S3 업로드 가이드

## 📋 개요

Rolling Window 시스템을 정상 작동시키기 위해 기존 마스터 데이터셋을 S3에 수동으로 업로드하는 방법을 안내합니다.

## 🎯 목적

- **Rolling Window 시스템 활성화**: 21개월 데이터 보존 및 자동 업데이트
- **학습용 마스터 데이터 제공**: 모델 학습을 위한 통합 데이터셋
- **Airflow 파이프라인 연동**: 1시간마다 자동 데이터 업데이트 준비

## 📂 업로드할 파일

### 파일 정보
- **파일명**: `weather_pm10_integrated_full.csv`
- **위치**: 프로젝트 루트 디렉토리
- **내용**: 기존 21개월치 기상 + PM10 통합 데이터
- **용도**: Rolling Window 시스템의 기준점

### 데이터 구조
```csv
datetime,STN,temperature,pm10,...
2024-01-01 00:00:00,108,12.5,45.2,...
2024-01-01 01:00:00,108,12.8,43.1,...
...
```

## 🗂️ S3 업로드 위치

### 정확한 S3 경로
```
s3://{your-bucket-name}/weather_pm10_integrated_full.csv
```

### S3 버킷 구조
```
s3://your-bucket/
├── weather_pm10_integrated_full.csv          ← 🎯 여기에 업로드
├── raw/
│   ├── asos/
│   │   └── year=YYYY/month=MM/day=DD/
│   └── pm10/
│       └── year=YYYY/month=MM/day=DD/
├── processed/
│   ├── asos/
│   │   └── year=YYYY/month=MM/day=DD/
│   └── pm10/
│       └── year=YYYY/month=MM/day=DD/
└── ml_dataset/
    └── year=YYYY/month=MM/day=DD/
        ├── dataset_HHMMSS.parquet                    # 실시간 추론용
        └── dataset_HHMMSS_training_master.parquet    # 학습용 마스터
```

## 🚀 업로드 방법

### 1. AWS S3 Console 사용
1. AWS S3 콘솔 접속
2. 해당 버킷 선택
3. **루트 폴더**에 `weather_pm10_integrated_full.csv` 업로드
4. 파일명이 정확한지 확인

### 2. AWS CLI 사용
```bash
aws s3 cp weather_pm10_integrated_full.csv s3://your-bucket-name/weather_pm10_integrated_full.csv
```

### 3. LocalStack 환경 (개발용)
```bash
aws --endpoint-url=http://localhost:4566 s3 cp weather_pm10_integrated_full.csv s3://your-bucket-name/weather_pm10_integrated_full.csv
```

## ✅ 업로드 검증

### 1. 파일 존재 확인
```bash
# AWS S3
aws s3 ls s3://your-bucket-name/weather_pm10_integrated_full.csv

# LocalStack
aws --endpoint-url=http://localhost:4566 s3 ls s3://your-bucket-name/weather_pm10_integrated_full.csv
```

### 2. 파일 크기 확인
- 업로드된 파일 크기가 로컬 파일과 동일한지 확인
- CSV 파일이므로 압축되지 않은 원본 크기여야 함

## 🔄 업로드 후 동작

### 자동 시스템 활성화
업로드 완료 후 다음 Airflow 실행 시:

1. **기존 데이터 로드**: S3에서 마스터 파일 다운로드
2. **새 데이터 병합**: 실시간 수집 데이터와 통합
3. **Rolling Window 적용**: 21개월(630일) 이전 데이터 삭제
4. **중복 제거**: datetime + station_id 기준 정리
5. **S3 재업로드**: 업데이트된 마스터 파일 저장
6. **ML 데이터셋 생성**: 학습용 데이터셋 자동 생성

### Rolling Window 동작 예시
```
업로드 시점 데이터: 2023-01-01 ~ 2025-09-26
첫 실행 (2025-09-26): 2024-01-05 이후 데이터만 유지
다음 실행 (2025-09-26): 2024-01-05 이후 데이터 + 새 데이터
...
지속적으로 21개월치만 유지
```

## 📊 시스템 구성 요소

### 관련 코드 파일
| 파일 | 역할 | 관련 메서드 |
|------|------|-------------|
| `src/data/weather_processor.py` | Rolling Window 로직 | `update_master_training_dataset()` |
| `src/storage/s3_client.py` | S3 업로드/다운로드 | `save_csv_to_s3()`, `load_csv_from_s3()` |

### 필수 메서드
```python
# S3에서 CSV 로드
weather_handler.load_csv_from_s3("weather_pm10_integrated_full.csv")

# S3에 CSV 저장
weather_handler.save_csv_to_s3(df, "weather_pm10_integrated_full.csv")
```

## ⚠️ 주의사항

### 파일명 정확성
- **정확한 파일명**: `weather_pm10_integrated_full.csv`
- **대소문자 구분**: 파일명 대소문자가 정확해야 함
- **확장자 필수**: `.csv` 확장자 반드시 포함

### 업로드 위치
- **루트 폴더**: 버킷의 루트에 직접 업로드 (폴더 안에 넣지 말 것)
- **경로 확인**: `s3://bucket-name/weather_pm10_integrated_full.csv`
- **하위 폴더 금지**: `s3://bucket-name/data/weather_pm10_integrated_full.csv` ❌

### 데이터 무결성
- **원본 보존**: 로컬 파일은 백업으로 보관
- **인코딩 확인**: UTF-8 인코딩 유지
- **컬럼 구조**: 기존 데이터 스키마와 일치 확인

## 🔍 트러블슈팅

### 일반적인 오류

#### 1. 파일을 찾을 수 없음
```
Error: NoSuchKey: The specified key does not exist
```
**해결**: 파일명과 업로드 위치 재확인

#### 2. 권한 오류
```
Error: AccessDenied: Access Denied
```
**해결**: S3 버킷 쓰기 권한 확인

#### 3. 인코딩 오류
```
Error: UnicodeDecodeError
```
**해결**: CSV 파일을 UTF-8로 다시 저장

### 검증 명령어
```bash
# 파일 존재 확인
aws s3 ls s3://your-bucket-name/ | grep weather_pm10

# 파일 내용 미리보기 (처음 10줄)
aws s3 cp s3://your-bucket-name/weather_pm10_integrated_full.csv - | head -10
```

## 🎉 완료 확인

업로드가 성공적으로 완료되면:

1. **✅ S3에 파일 존재**: 버킷 루트에 CSV 파일 확인
2. **✅ Rolling Window 준비**: 다음 Airflow 실행 시 자동 작동
3. **✅ 시스템 통합**: 실시간 데이터와 마스터 데이터 연동
4. **✅ ML 파이프라인**: 학습용 데이터셋 자동 생성

## 📞 문의사항

### 업로드 관련
- 파일이 너무 큰 경우: 청크 업로드 또는 압축 고려
- 네트워크 오류: 재시도 또는 다른 업로드 방법 시도

### 시스템 관련
- Rolling Window 동작 확인: Airflow 로그 모니터링
- 데이터 정합성: 업로드 후 첫 실행 결과 검증

---

**작성일**: 2025-09-26
**용도**: Rolling Window 시스템 초기 설정
**다음 단계**: 업로드 완료 후 Airflow 실행 모니터링