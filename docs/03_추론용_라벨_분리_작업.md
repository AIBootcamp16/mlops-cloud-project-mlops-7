# 추론용 데이터에서 정답 라벨(comfort_score) 제거 작업

## 📋 작업 개요

실시간 추론용 데이터에 **정답 라벨(comfort_score)**이 포함되는 문제를 해결하기 위해 추론용과 학습용 데이터셋을 명확히 분리했습니다.

## 🚨 문제 상황

### 발견된 이슈
- **실시간 S3 적재**: 추론용 데이터에도 `comfort_score` 포함
- **논리적 모순**: 실시간 추론 시에는 정답을 알 수 없음
- **데이터 오염**: 추론용 데이터에 정답이 포함되어 부정확한 평가 가능

### 문제 영향
```python
# ❌ 잘못된 상황
실시간 데이터 → ML 데이터셋 생성 → comfort_score 포함 → S3 저장
                                    ↑
                              실제로는 알 수 없는 정답
```

## 🔧 해결 방안

### 핵심 아이디어: 조건부 라벨 포함
- **추론용 데이터**: `include_labels=False` → comfort_score 제외
- **학습용 데이터**: `include_labels=True` → comfort_score 포함

## 📝 구현 상세

### 1. Feature Builder 수정

**파일**: `src/features/feature_builder.py`

**함수 시그니처 변경**:
```python
# Before
def create_ml_dataset(raw_data: Dict[str, Any]) -> pd.DataFrame:

# After
def create_ml_dataset(raw_data: Dict[str, Any], include_labels: bool = False) -> pd.DataFrame:
    """
    Args:
        raw_data: 원시 기상 데이터
        include_labels: True면 comfort_score(정답) 포함, False면 추론용
    """
```

**조건부 라벨 생성**:
```python
def add_engineered_features(df: pd.DataFrame, include_labels: bool = False) -> pd.DataFrame:
    # ... 기본 피처 생성 ...

    # 5. 종합 쾌적지수 계산 (학습용만)
    if include_labels:
        df['comfort_score'] = calculate_comfort_score(df)
        # 학습용: comfort_score 포함
    # else: 추론용은 comfort_score 생성하지 않음

    return df
```

### 2. 실시간 처리 로직 수정

**파일**: `src/data/weather_processor.py`

**실시간 데이터 처리 (추론용)**:
```python
def process_and_store_weather_data(self, ...):
    # ...
    if parsed_asos or parsed_pm10:
        raw_data = {"asos": parsed_asos, "pm10": parsed_pm10}
        ml_dataset = create_ml_dataset(raw_data, include_labels=False)  # 실시간 추론용: 정답 제외
        #                                            ↑
        #                                    핵심: False로 설정
```

**Rolling Window 업데이트 (학습용)**:
```python
def update_master_training_dataset(self, ...):
    # ...
    if raw_data_for_ml:
        ml_dataset = create_ml_dataset(raw_data_for_ml, include_labels=True)  # 학습용: 정답 포함
        #                                               ↑
        #                                       핵심: True로 설정
```

### 3. S3 저장 메서드 확장

**파일**: `src/storage/s3_client.py`

**key_suffix 지원 추가**:
```python
def save_ml_dataset(self, df: pd.DataFrame, timestamp: datetime, key_suffix: str = None) -> str:
    """ML 데이터셋 저장"""
    if key_suffix:
        key = f"ml_dataset/{date_str}/dataset_{time_str}_{key_suffix}.parquet"
        #                                                    ↑
        #                                        학습용: training_master 추가
    else:
        key = f"ml_dataset/{date_str}/dataset_{time_str}.parquet"
        #                                       ↑
        #                               추론용: 기본 파일명
```

## 📊 데이터 구조 변화

### S3 저장 구조

**Before (잘못된 상황)**:
```
ml_dataset/2025/09/26/
└── dataset_150000.parquet
    ├── station_id: 108
    ├── datetime: 2025-09-26 15:00:00
    ├── temperature: 22.5
    ├── pm10: 35.0
    ├── [30개 피처들...]
    └── comfort_score: 75.2  ❌ 추론 시에는 알 수 없는 정답
```

**After (올바른 상황)**:
```
ml_dataset/2025/09/26/
├── dataset_150000.parquet                     # 추론용
│   ├── station_id: 108
│   ├── datetime: 2025-09-26 15:00:00
│   ├── temperature: 22.5
│   ├── pm10: 35.0
│   └── [30개 피처들...]                       # comfort_score 없음 ✅
│
└── dataset_150000_training_master.parquet     # 학습용 (Rolling Window)
    ├── station_id: 108
    ├── datetime: 2025-09-26 15:00:00
    ├── temperature: 22.5
    ├── pm10: 35.0
    ├── [30개 피처들...]
    └── comfort_score: 75.2                    # 정답 포함 ✅
```

### 용도별 데이터 분류

| 데이터 타입 | include_labels | comfort_score | 용도 | 파일명 패턴 |
|------------|----------------|---------------|------|-------------|
| **실시간 추론용** | `False` | ❌ 없음 | 모델 추론 | `dataset_HHMMSS.parquet` |
| **학습용 마스터** | `True` | ✅ 포함 | 모델 학습/검증 | `dataset_HHMMSS_training_master.parquet` |

## 🔄 데이터 플로우 개선

### Before (문제 상황)
```
실시간 데이터 수집
    ↓
ML 데이터셋 생성 (comfort_score 포함) ❌
    ↓
S3 저장 (추론용인데 정답 포함) ❌
```

### After (해결된 상황)
```
실시간 데이터 수집
    ↓
┌─ 실시간 ML 데이터셋 (include_labels=False) ✅
│   └─ S3 저장 (추론용, comfort_score 없음)
│
└─ Rolling Window 업데이트
    └─ 학습용 ML 데이터셋 (include_labels=True) ✅
        └─ S3 저장 (학습용, comfort_score 포함)
```

## 💡 설계 원칙

### 1. 명확한 책임 분리
- **실시간 추론**: 알고 있는 기상 데이터만으로 예측
- **모델 학습**: 과거 데이터의 실제 쾌적지수로 학습

### 2. 데이터 무결성
- **추론 시점**: comfort_score는 아직 알 수 없는 미래 값
- **학습 시점**: comfort_score는 이미 관측된 과거 값

### 3. 논리적 일관성
```python
# ✅ 올바른 사용법
# 실시간 추론 (15:00에 실행)
features = create_ml_dataset(current_weather, include_labels=False)  # 15:00의 쾌적지수는 아직 모름
prediction = model.predict(features)  # 모델이 예측

# 학습 (과거 데이터로)
features = create_ml_dataset(historical_weather, include_labels=True)  # 과거의 쾌적지수는 이미 관측됨
model.train(features)  # 실제 값으로 학습
```

## ✅ 검증 결과

### 1. 추론용 데이터 검증
```python
# 실시간 데이터셋 생성 테스트
ml_dataset = create_ml_dataset(raw_data, include_labels=False)
assert 'comfort_score' not in ml_dataset.columns  # ✅ 통과
```

### 2. 학습용 데이터 검증
```python
# 학습용 데이터셋 생성 테스트
ml_dataset = create_ml_dataset(raw_data, include_labels=True)
assert 'comfort_score' in ml_dataset.columns  # ✅ 통과
```

### 3. 파일 구조 검증
```
S3 버킷 확인:
✅ dataset_150000.parquet (추론용) - comfort_score 없음
✅ dataset_150000_training_master.parquet (학습용) - comfort_score 포함
```

## 📈 성능 및 품질 영향

### 1. 데이터 품질 향상
- **논리적 일관성**: 추론 시에는 정답을 사용하지 않음
- **평가 정확성**: 모델 성능 평가 시 데이터 오염 방지
- **실제 운영 반영**: 실제 배포 환경과 동일한 조건

### 2. 스토리지 효율성
- **추론용**: comfort_score 없어서 약간 경량화
- **학습용**: Rolling Window로 생성되므로 추가 부담 없음

### 3. 운영 안정성
- **명확한 구분**: 추론용/학습용 데이터 명확히 분리
- **실수 방지**: include_labels 플래그로 의도 명시
- **확장성**: 향후 다른 라벨 추가 시에도 동일 패턴 적용 가능

## ⚠️ 주의사항

### 1. 기존 코드 수정 필요
```python
# ❌ 기존 코드 (문제 있음)
ml_dataset = create_ml_dataset(raw_data)  # 기본값으로 labels 포함됨

# ✅ 수정된 코드
ml_dataset = create_ml_dataset(raw_data, include_labels=False)  # 명시적으로 추론용 지정
```

### 2. 모델 추론 시 주의
- 실시간 추론용 데이터는 comfort_score 컬럼이 없으므로 모델 input shape 확인 필요
- 기존 모델이 comfort_score를 input으로 사용했다면 재학습 필요

### 3. 모니터링 포인트
- 실시간 ML 데이터셋에 comfort_score 없음 확인
- 학습용 ML 데이터셋에 comfort_score 포함 확인
- 파일명 패턴 정확성 확인

## 🚀 적용 상태

### 완료된 작업
- ✅ **Feature Builder 수정**: `include_labels` 파라미터 추가
- ✅ **실시간 처리**: 추론용 데이터에서 comfort_score 제거
- ✅ **학습용 처리**: Rolling Window에서 comfort_score 포함 유지
- ✅ **S3 저장**: 용도별 파일명 구분 (training_master suffix)

### 즉시 적용됨
- 다음 Airflow 실행부터 추론용 데이터에서 comfort_score 제거
- Rolling Window 업데이트 시 학습용 데이터에는 comfort_score 포함
- 명확한 파일명으로 용도 구분

## 📞 FAQ

**Q: 기존 모델은 어떻게 되나요?**
A: 기존 모델이 comfort_score를 input으로 사용하지 않았다면 그대로 사용 가능합니다. 만약 사용했다면 재학습이 필요합니다.

**Q: comfort_score는 완전히 사라지나요?**
A: 아닙니다. 학습용 데이터(`training_master`)에는 여전히 포함되어 모델 학습에 사용됩니다. 실시간 추론용에서만 제거됩니다.

**Q: 파일명이 복잡해지는데 괜찮나요?**
A: `training_master` suffix로 명확히 구분되므로 용도를 쉽게 식별할 수 있습니다. 운영상 혼동을 방지하는 효과가 더 큽니다.

---

**작성일**: 2025-09-26
**작업자**: Claude
**영향범위**: 실시간 ML 데이터 생성, S3 저장 구조
**상태**: 완료 및 다음 Airflow 실행부터 적용